<?php

/**
 * @file
 * Contains search_log.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Form\FormStateInterface;
/**
 * Implements hook_help().
 */
function search_log_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the search_log module.
    case 'help.page.search_log':
    $output = '';
    $output .= '<h3>' . t('About') . '</h3>';
    $output .= '<p>' . t('maintains search history') . '</p>';
    return $output;

    default:
  }
}

/**
 * Implements hook_theme().
 */
function search_log_theme() {
  return [
    'search_log' => [
      'render element' => 'children',
    ],
  ];
}

/**
 * Implements hook_form_alter().
 */
// function search_log_form_alter(&$form, FormStateInterface $form_state, $form_id){
//   if($form_id == 'search_block_form') {
//        // print_r($form_state->getValue('Keys'));
//        // die();
//      array_unshift($form ['#submit'],'search_log_search_block_form_submit');
//      // array_unshift($form ['actions']['submit']['#submit'][], 'search_log_search_block_form_submit');

//   }

// }

// function search_log_search_block_form_submit($form, FormStateInterface $form_state) {
//   // print_r("Test");
//   // print_r($form_state->getValue(('Keys'));
//   //  die();
//   print_r('submit handler called ');
//   die();
// }
/**
 * Implements hook_submit_form().
 */
 // function search_log_form_submit(array &$form, FormStateInterface $form_state){

// }

function search_log_search_preprocess($text, $langcode = NULL){

 if (!isset($langcode)) {
  $langcode = \Drupal::languageManager()
  ->getCurrentLanguage()
  ->getId();
}

$query = \Drupal::database()->select('search_log','search_log');
$query->fields('search_log',['searchterm','counter','language','result','module']);
$searchTerm = $query->execute()->fetchAll();
// $Counter=$searchTerm[0]->counter;
$flag=0;
if(empty($searchTerm)){
  $query= \Drupal::database()->insert('search_log');
  $query->fields([
    'searchterm' => $text,

    'language' => $langcode,
  ]);
  $query->execute();
  $flag=2;
}

foreach ($searchTerm as $key => $value) {
  if($value->searchterm == $text){

    $flag=1;

  }
}
if($flag==1)
{
  $Count = $value->counter;
  $query =\Drupal::database()->update('search_log');
  $query->fields(['counter'=>$Count+1]);
  $query->condition('searchterm',$value=$text);
  $query->execute();
 
}
else if($flag==0)
{
  $query= \Drupal::database()->insert('search_log');
  $query->fields([
    'searchterm' => $text,
    'counter' => 1,
    'language' => $langcode,
  ]);
  $query->execute();
 

}








}
